<!--
Copyright 2016 Google Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>IndexedDB Codelab testing</title>
  <link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.0.1.css">
  <script type="text/javascript" src="../js/idb.js"></script>
  <!-- <script type="text/javascript" src="../js/main.js"></script> -->
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <script src="https://code.jquery.com/qunit/qunit-2.0.1.js"></script>
  <script>
    function promisifyRequest(request) {
      return new Promise(function(resolve, reject) {
        request.onsuccess = function() {
          resolve(request.result);
        };

        request.onerror = function() {
          reject(request.error);
        };
      });
    }

    function dbExist() {
      var dbExists = false;
      // Webkit only works in Chrome
      return promisifyRequest(indexedDB.webkitGetDatabaseNames())
      .then(function(dbNames) {
        for (name in dbNames) {
          if (dbNames[name] == 'couches-n-things') {
            dbExists = true;
            break;
          }
        }
        return dbExists;
      }).catch(function() {
        console.log('Browser doesn\'t support webkitGetDatabaseNames().' +
        'Use Chrome');
      });
    }

    QUnit.test('Was couches-n-things database created?', function(assert) {
      var done = assert.async();
      var dbNames;
      dbExist().then(function(dbExists) {
        assert.ok(dbExists, 'couches-n-things database exists');
        done();
      });
      //
      // idb.open('couches-n-things', 1, function(upgradeDb) {
      //   dbExists = false;
      // }).then(function() {
      //   if (!dbExists) {
      //     indexedDB.deleteDatabase('couches-n-things');
      //   }
      //   assert.ok(dbExists, 'couches-n-things database exists');
      //   done();
      // });
      // idb.open('couches-n-things', 1, function(upgradeDb) {
      //   dbExists = false;
      //   upgradeDb.transaction.abort();
      // }).then(function() {
      //   assert.ok(dbExists, 'couches-n-things database exists');
      //   done();
      // });
      //
      // var request = window.indexedDB.open('couches-n-things');
      // request.onupgradeneeded = function(e) {
      //   console.log('in upgradeneeded');
      //   dbExists = false;
      //   e.target.transaction.abort();
      // };
      // assert.ok(dbExists, 'couches-n-things database exists');
      // done();
      //
      // idb.open('couches-n-things').then(function(db) {
      //   assert.equal(db.name, 'couches-n-things', 'couches-n-things exists');
      //   done();
      // });
      //
      // dbPromise.then(function(db) {
      //   console.log('database object: ', db);
      //   assert.ok(dbExists, 'couches-n-things database exists');
      //   done();
      // });
    });

    QUnit.test('Was products object store created?', function(assert) {
      var done = assert.async();
      osExists = false;
      dbExist().then(function(dbExists) {
        if (dbExists) {
          return idb.open('couches-n-things').then(function(db) {
            if (db.objectStoreNames.contains('products')) {
              osExists = true;
            }
          });
        }
      }).then(function() {
        assert.ok(osExists, 'products object store exists');
        done();
      });
    });

    QUnit.test('Are the sample objects in the store?', function(assert) {
      var done = assert.async();
      var bProds = false;
      dbExist().then(function(dbExists) {
        if (dbExists) {
          return idb.open('couches-n-things').then(function(db) {
            if (db.objectStoreNames.contains('products')) {
              var tx = db.transaction('products');
              var productsOS = tx.objectStore('products');
              return productsOS.getAll();
            }
            return [];
          }).then(function(arrProducts) {
            if (arrProducts.length > 0) {
              bProds = true;
            }
          });
        }
      }).then(function() {
        assert.ok(bProds, 'Products exist in the store');
        done();
      });
    });

    function testIndex(indexName) {
      QUnit.test('Was ' + indexName + ' index created on the products store?',
      function(assert) {
        var done = assert.async();
        var indexExists = false;
        dbExist().then(function(dbExists) {
          if (dbExists) {
            return idb.open('couches-n-things').then(function(db) {
              if (db.objectStoreNames.contains('products')) {
                var tx = db.transaction('products');
                var productsOS = tx.objectStore('products');
                return productsOS.indexNames;
              }
              return [];
            }).then(function(indexes) {
              for (index in indexes) {
                if (indexes[index] == indexName) {
                  indexExists = true;
                  break;
                }
              }
            });
          }
        }).then(function() {
          assert.ok(indexExists, 'name index exists');
          done();
        });
      });
    }
    testIndex('name');
    testIndex('price');
    testIndex('description');
  </script>
</body>
</html>
